 - A query that uses `GROUPING SETS` to do efficient aggregations of `game_details` data
 - Aggregate this dataset along the following dimensions
   - player and team
     - Answer questions like who scored the most points playing for one team?
   - player and season
     - Answer questions like who scored the most points in one season?
   - team
     - Answer questions like which team has won the most games?
    




WITH agg AS (
    SELECT 
        player_id,
        team_id,
        season,
        SUM(COALESCE(pts, 0)) AS total_points,
        SUM(COALESCE(plus_minus, 0)) AS total_victory,
        GROUPING(player_id) AS g_player,
        GROUPING(team_id) AS g_team,
        GROUPING(season) AS g_season
    FROM game_details gd
    LEFT JOIN games g ON gd.game_id = g.game_id
    GROUP BY GROUPING SETS (
        (player_id, team_id),    -- player & team
        (player_id, season),     -- player & season
        (team_id)                -- team only
    )
)


-- 1️⃣ Player & Team: top scorer per team
, player_team_top AS (
    SELECT *
    FROM (
        SELECT *,
               ROW_NUMBER() OVER (PARTITION BY team_id ORDER BY total_points DESC) AS rn
        FROM agg
        WHERE g_player = 0 AND g_team = 0 AND g_season = 1   -- (player_id, team_id) grouping
    ) t
    WHERE rn = 1
)
-- 2️⃣ Player & Season: top scorer per season
, player_season_top AS (
    SELECT *
    FROM (
        SELECT *,
               ROW_NUMBER() OVER (PARTITION BY season ORDER BY total_points DESC) AS rn
        FROM agg
        WHERE g_player = 0 AND g_team = 1 AND g_season = 0   -- (player_id, season) grouping
    ) t
    WHERE rn = 1
)
-- 3️⃣ Team: team with most wins
, team_top AS (
    SELECT *
    FROM (
        SELECT *,
               ROW_NUMBER() OVER (ORDER BY total_victory DESC) AS rn
        FROM agg
        WHERE g_player = 1 AND g_team = 0 AND g_season = 1   -- (team_id) grouping
    ) t
    WHERE rn = 1
)
SELECT 'Player & Team Top Scorer' AS metric, 
       team_id, 
       player_id, 
       NULL AS season,        -- season not relevant here
       total_points
FROM player_team_top


UNION ALL


SELECT 'Player & Season Top Scorer', 
       NULL AS team_id, 
       player_id, 
       season,               -- include season
       total_points
FROM player_season_top


UNION ALL


SELECT 'Team with Most Wins', 
       team_id, 
       NULL AS player_id, 
       NULL AS season,       -- season not relevant
       total_victory AS total_points
FROM team_top;
